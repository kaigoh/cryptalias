version: "3.9"

networks:
  cryptalias:
    name: cryptalias

services:
  traefik:
    image: traefik:v3.1
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --api.dashboard=true
      # Dev-only dashboard on :8080
      - --api.insecure=true
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - cryptalias

  monero-wallet-rpc:
    image: espejelomar/monero-wallet-rpc:latest
    command:
      - --confirm-external-bind
      - --rpc-bind-ip=0.0.0.0
      - --rpc-bind-port=18083
      - --rpc-login=${MONERO_RPC_USER:-cryptalias}:${MONERO_RPC_PASS:-change-me}
      - --wallet-dir=/home/monero/wallet
      - --daemon-address=${MONERO_DAEMON_ADDRESS:-monerod:18081}
    volumes:
      - ./monero:/home/monero/
    networks:
      - cryptalias

  cryptalias:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["/config/config.yml"]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q -O - http://127.0.0.1:8080/healthz >/dev/null || exit 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    volumes:
      - ./config.yml:/config/config.yml
    depends_on:
      - monero-wallet-rpc
    networks:
      - cryptalias
    labels:
      - traefik.enable=true
      - traefik.docker.network=cryptalias
      - traefik.http.routers.cryptalias.rule=Host(`cryptalias.localhost`)
      - traefik.http.routers.cryptalias.entrypoints=web
      - traefik.http.services.cryptalias.loadbalancer.server.port=8080
